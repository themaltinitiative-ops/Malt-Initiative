<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Transparence – Informations du lot</title>
<style>
/* --- RESET ET BODY --- */
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #F7F3ED;
    color: #0f1724;
    padding: 0;
}

/* Loader */
#loader {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(255,255,255,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
    display: none; /* caché par défaut */
}
#loader img {
    width: 150px;
    animation: spin 1.5s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Bannière */
.header-images img { width: 100%; height: auto; display: block; }

/* --- TITRE --- */
h1 {
    text-align: center;
    margin: 20px 0;
}

/* --- CHAMP DE LOT --- */
#lotInput, button {
    font-size: 16px;
}

/* --- ACCORDIONS --- */
.accordion {
    background: #f0e6d2;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    margin: 20px auto;
    max-width: 900px;
}

.accordion-header {
    background-size: cover;
    background-position: center;
    height: 120px;
    position: relative;
    cursor: pointer;
    display: flex;
    align-items: center;
    padding-left: 20px;
}

.accordion-header::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.25);
}

.accordion-title {
    position: relative;
    font-size: 22px;
    color: white;
    font-weight: bold;
    z-index: 5;
}

.accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
    background: #fff;
    padding: 0 20px;
}

.accordion-content.open {
    padding: 20px;
}

/* --- LISTES --- */
ul {
    margin: 10px 0 20px 20px;
    padding: 0;
    list-style-type: disc;
}

ul li {
    margin-bottom: 6px;
}

/* simple table style for lists */
.table-list { width: 100%; border-collapse: collapse; margin-top: 12px; }
.table-list th, .table-list td { border: 1px solid #e6e6e6; padding: 8px; text-align: left; }
.table-list th { background: #fafafa; }

/* --- FOOTER --- */
footer {
    background: #e2e2e2;
    padding: 20px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
}

footer .footer-block {
    display: flex;
    align-items: center;
    margin: 10px;
}

footer .footer-block img {
    max-width: 80px;
    margin-right: 15px;
}

footer .footer-text {
    font-size: 14px;
    line-height: 1.4;
}

/* small responsive */
@media (max-width:600px){
    .accordion-header { height: 90px; padding-left: 12px; }
    .accordion-title { font-size: 18px; }
}
</style>
</head>
<body>

<!-- Loader -->
<div id="loader" aria-hidden="true" style="display:none;">
    <img src="Dessin_chope_de_biere_480x480-removebg-preview.png" alt="Chargement...">
</div>

<!-- BANNIERE -->
<div class="header-images">
    <img src="bannire-fine.png" alt="Bannière The Malt Initiative">
</div>

<h1>Informations du Lot</h1>

<!-- CHAMP DE SAISIE DU LOT -->
<div style="text-align:center; margin:20px;">
    <label for="lotInput"><strong>Entrer le numéro de lot :</strong></label>
    <input type="text" id="lotInput" placeholder="Ex : 202603" style="padding:6px 10px; border-radius:6px; border:1px solid #ccc;">
    <button id="loadBtn" style="padding: 6px 12px; border-radius: 6px; border: none; background: rgb(21, 128, 61); color: white;">Charger le lot</button>
</div>

<!-- ACCORDÉON AGRICULTEURS -->
<div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)" style="background-image:url('barley.jpg');">
        <div class="accordion-title">Agriculteurs</div>
    </div>
    <div class="accordion-content">
        <div id="agriculteursList">Aucune donnée pour le moment.</div>
    </div>
</div>

<!-- ACCORDÉON COOPÉRATIVES -->
<div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)" style="background-image:url('malt-4950433_1280.jpg');">
        <div class="accordion-title">Coopératives</div>
    </div>
    <div class="accordion-content">
        <div id="cooperativesList">Aucune donnée pour le moment.</div>
    </div>
</div>

<!-- ACCORDÉON BRASSERIES -->
<div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)" style="background-image:url('beer-2370783_1280.jpg');">
        <div class="accordion-title">Brasseries</div>
    </div>
    <div class="accordion-content">
        <div id="brasseriesList">Aucune donnée pour le moment.</div>
    </div>
</div>

<!-- FOOTER -->
<footer>
    <div class="footer-infos">
        <div class="footer-block">
            <img src="Capture_d_écran_2025-11-17_220106-removebg-preview.png" alt="">
            <div class="footer-text">
                <strong>Malterie Occitane</strong><br>
                malterieoccitane.fr<br>
                1273 Avenue des Terres Noires, 81370 St Sulpice la Pointe
            </div>
        </div>

        <div class="footer-block">
            <img src="content.png" alt="">
            <div class="footer-text">
                <strong>The Malt Initiative – Projet Grain Trust :</strong><br>
                Projet Ingénieur Agronome de l’AgroToulouse<br>
                Mail : themaltinitiative@gmail.com
            </div>
        </div>
    </div>
</footer>

<script>
// --- ACCORDION ---
function toggleAccordion(header){
    const content = header.nextElementSibling;
    const isOpen = content.style.maxHeight;

    document.querySelectorAll('.accordion-content').forEach(c => {
        c.style.maxHeight = null;
        c.classList.remove("open");
    });

    if(!isOpen){
        content.style.maxHeight = content.scrollHeight + "px";
        content.classList.add("open");
    }
}

// parser CSV robuste : tab ou comma, gère CRLF
function parseCSVtable(text){
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
    if (!lines.length) return [];
    // Try tab first
    const sep = lines[0].includes('\t') ? '\t' : ',';
    const headers = lines[0].split(sep).map(h => h.trim());
    return lines.slice(1).map(line => {
        const cols = line.split(sep);
        const obj = {};
        headers.forEach((h,i) => obj[h] = (cols[i]||'').trim());
        return obj;
    });
}

// Render table for a given array of objects (shows Prénom / Nom and full object as details)
function renderTable(arr){
    if (!arr || arr.length === 0) return '<p>Aucune donnée.</p>';
    // pick columns safely
    const first = arr[0];
    const headers = Object.keys(first);
    let html = '<table class="table-list"><thead><tr>';
    html += '<th>Prénom</th><th>Nom</th><th>Autres infos</th></tr></thead><tbody>';
    arr.forEach(row => {
        const prenom = row["Identification [Prénom de l'exploitant :]"] || row["Prénom"] || '';
        const nom = row["Identification [Nom de l'exploitant :]"] || row["Nom"] || '';
        // create a small details string for remaining columns
        const others = headers.filter(h => h !== "Identification [Prénom de l'exploitant :]" && h !== "Identification [Nom de l'exploitant :]").map(h => {
            return `<strong>${h}:</strong> ${row[h]||'—'}`;
        }).join(' · ');
        html += `<tr><td>${prenom}</td><td>${nom}</td><td>${others}</td></tr>`;
    });
    html += '</tbody></table>';
    return html;
}

// normalize category strings for matching
function normalizeCat(s){
    if(!s) return '';
    return s.trim().toLowerCase();
}

// --- CHARGEMENT DU CSV ---
async function loadLot(){
    const loadBtn = document.getElementById('loadBtn');
    const lotId = document.getElementById('lotInput').value.trim();
    if (!lotId) {
        alert("Veuillez entrer un numéro de lot !");
        return;
    }

    // Vérification majorité
    const isAdult = confirm("Ce site présente des informations liées à l'alcool.\nConfirmez-vous avoir plus de 18 ans ?");
    if (!isAdult) {
        alert("Accès refusé : vous devez être majeur pour continuer.");
        return;
    }

    // montrer loader + désactiver bouton
    const loader = document.getElementById('loader');
    loader.style.display = "flex";
    loader.setAttribute('aria-hidden','false');
    loadBtn.disabled = true;
    loadBtn.style.opacity = 0.6;
    loadBtn.style.cursor = 'not-allowed';

    // attente forcée 1s
    await new Promise(r => setTimeout(r, 1000));

    // fichier CSV (change si tu ranges ailleurs)
    const csvUrl = `https://raw.githubusercontent.com/themaltinitiative-ops/Malt-Initiative/master/data/${lotId}.csv`;

    try {
        const res = await fetch(csvUrl);
        if (!res.ok) throw new Error("Fichier CSV introuvable : " + csvUrl);
        const text = await res.text();
        const rows = parseCSVtable(text);

        // filter by category column (robust to small variations)
        const catKeyCandidates = [
            "Quel maillon de la chaîne êtes-vous ?",
            "Quel maillon êtes-vous ?",
            "Maillon",
            "Quel maillon"
        ];
        // detect actual category column name
        let catKey = null;
        if (rows.length) {
            const keys = Object.keys(rows[0]);
            for (const k of keys){
                if (catKeyCandidates.includes(k)) { catKey = k; break; }
            }
            if (!catKey) {
                // try fuzzy: pick first column name containing 'maillon' or 'qui' etc
                catKey = keys.find(k => /maillon|chaine|chaîne|quel/i.test(k)) || keys[0];
            }
        }

        // categorize entries
        const agris = [];
        const coops = [];
        const brasseries = [];

        rows.forEach(r => {
            const cat = normalizeCat(r[catKey]);
            if (cat.includes('agricul')) agris.push(r);
            else if (cat.includes('coop')) coops.push(r);
            else if (cat.includes('brass') || cat.includes('brasseur')) brasseries.push(r);
            else {
                // fallback: if unknown but row contains typical agriculteur fields, push to agris
                agris.push(r);
            }
        });

        // render into accordions
        document.getElementById('agriculteursList').innerHTML = renderTable(agris);
        document.getElementById('cooperativesList').innerHTML = renderTable(coops);
        document.getElementById('brasseriesList').innerHTML = renderTable(brasseries);

        // open first accordion
        const firstHeader = document.querySelector('.accordion .accordion-header');
        if (firstHeader) toggleAccordion(firstHeader);

    } catch (err) {
        alert("Erreur : " + err.message);
    } finally {
        // cacher loader + réactiver bouton
        loader.style.display = "none";
        loader.setAttribute('aria-hidden','true');
        loadBtn.disabled = false;
        loadBtn.style.opacity = '';
        loadBtn.style.cursor = '';
    }
}

// lie le bouton au chargement
document.getElementById('loadBtn').addEventListener('click', loadLot);
</script>

</body>
</html>
