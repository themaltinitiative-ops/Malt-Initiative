<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Transparence – Informations du lot</title>
<style>
/* --- RESET ET BODY --- */
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #F7F3ED;
    color: #0f1724;
    padding: 0;
}

/* Loader */
#loader {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(255,255,255,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
    display: none;
}
#loader img {
    width: 150px;
    animation: spin 1.5s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

    #loadBtn {
    background-color: #e7b01d;
    color: #0f1724;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.1s ease;
}

#loadBtn:hover {
    background-color: #d4a017;
}

#loadBtn:active {
    transform: scale(0.97);
}

    
/* Bannière */
.header-images img { width: 100%; height: auto; display: block; }

/* --- TITRE --- */
h1 { text-align: center; margin: 20px 0; }

/* --- CHAMP DE LOT --- */
#lotInput, button { font-size: 16px; padding: 6px 10px; }

/* --- ACCORDIONS --- */
.accordion {
    background: #f0e6d2;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    margin: 20px auto;
    max-width: 900px;
}

.accordion-header {
    background-size: cover;
    background-position: center;
    height: 100px;
    position: relative;
    cursor: pointer;
}

.accordion-title {
    position: absolute;
    bottom: 10px;
    left: 20px;
    font-size: 26px;
    color: white;
    font-weight: bold;
    z-index: 5;
}

.accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.4s ease;
    background: #fff;
    padding: 0 20px;
}

/* --- RÉGLETTE CARBONE --- */
.carbon-rule {
    height: 48px;
    border-radius: 12px;
    background: #e5e7eb; /* cadre gris clair */
    overflow: hidden;
    margin-top: 12px;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.15);
}

.carbon-fill {
    height: 100%;
    display: flex;
    width: 100%;
}

.seg {
    height: 100%;
    transition: width 0.6s ease;
}
.seg.agri { background: #15803d; }
.seg.transp { background: #d9f99d; }
.seg.malt { background: #fde68a; }

.numbers {
    display: flex;
    gap: 16px;
    margin-top: 16px;
    flex-wrap: wrap;
}

.stat {
    padding: 14px;
    border-radius: 12px;
    border: 1px solid transparent;
    min-width: 140px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    font-size: 14px;
}

.stat.agri { background: #15803d; color: #fff; border-color: #064e3b; }
.stat.transp { background: #d9f99d; border-color: #15803d; }
.stat.malt { background: #fde68a; border-color: #b45309; }
.stat.total { background: #fff; border-color: #e2e8f0; color: #0f1724; }
.stat strong { display: block; font-size: 20px; margin-top: 4px; }


.accordion-content.open { padding: 20px; }

ul { margin: 10px 0 20px 20px; padding: 0; list-style-type: disc; }
ul li { margin-bottom: 6px; }

.intro-text {
    max-width: 900px;
    margin: 20px auto;
    font-size: 15px;
    line-height: 1;
    color: #0f1724;
    background: #f9f6ef; /* léger fond pour distinguer */
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.intro-text p {
    margin-bottom: 12px;
}

    .intro-card {
    max-width: 900px;
    margin: 20px auto;
    background: #ffffff; /* fond blanc */
    padding: 24px 32px;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.12); /* effet surélévation */
    font-size: 15px;
    line-height: 1.7;
    color: #0f1724;
    position: relative;
    z-index: 1;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.intro-card p {
    margin-bottom: 14px;
}

.intro-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.18);
}

    
/* --- FOOTER --- */
footer {
    background: #e2e2e2;
    padding: 20px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
}

footer .footer-block {
    display: flex;
    align-items: center;
    margin: 10px;
}

footer .footer-block img {
    max-width: 80px;
    margin-right: 15px;
}

footer .footer-text {
    font-size: 14px;
    line-height: 1.4;
}
</style>
</head>
<body>

<!-- Loader -->
<div id="loader" aria-hidden="true" style="display: none;">
    <!-- Remplacez le src par le chemin correct vers votre image -->
    <img src="Dessin_chope_de_biere_480x480-removebg-preview.png" alt="Chargement...">
</div>

<!-- BANNIERE -->
<div class="header-images">
    <img src="banniere.png" alt="Bannière The Malt Initiative">
</div>
    
<div class="intro-text">
    <p>La filière brassicole d’Occitanie connaît un fort essor grâce aux brasseries artisanales et aux terroirs locaux. La Malterie Occitane, fondée en 2019 dans le Tarn, produit du malt bio régional pour soutenir cette dynamique. Face à la concurrence industrielle, la valorisation du malt artisanal reste un enjeu majeur. La mise en place d’un outil de traçabilité vise à renforcer la transparence et la cohésion de la filière. Le projet Grain Trust associe traçabilité, données partenaires et empreinte carbone du produit fini.</p>
</div>

<h1>Informations du Lot</h1>

<!-- CHAMP DE SAISIE DU LOT -->
<div style="text-align:center; margin:20px;">
    <label for="lotInput"><strong>Entrer le numéro de lot :</strong></label>
    <input type="text" id="lotInput" placeholder="Ex : MO-1" style="padding:6px 10px; border-radius:6px; border:1px solid #ccc;">
    <button id="loadBtn" style="padding: 6px 12px; border-radius: 6px; border: none; background: rgb(21, 128, 61); color: white;">Charger le lot</button>
</div>

<!-- ACCORDÉON Empreinte carbone -->
<div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)" style="background-image:url(&#39;foret.jpg&#39;);">
        <div class="accordion-title">Empreinte carbone du lot</div>
    </div>
    <div class="accordion-content">

        <!-- RÉGLETTE CARBONE -->
        <div class="carbon-rule">
            <div class="carbon-fill">
                <div class="seg agri" id="segAgriculture"></div>
                <div class="seg transp" id="segTransport"></div>
                <div class="seg malt" id="segMalterie"></div>
            </div>
        </div>

        <!-- VALEURS -->
        <div class="numbers">
            <div class="stat agri">Agriculture <strong id="statAgriculture">—</strong></div>
            <div class="stat transp">Transport <strong id="statTransport">—</strong></div>
            <div class="stat malt">Malterie <strong id="statMalterie">—</strong></div>
            <div class="stat total">Total <strong id="statTotal">—</strong></div>
        </div>
    </div>
</div>




    
<!-- ACCORDÉONS Agriculture-->
<div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)" style="background-image:url(&#39;barley.jpg&#39;);">
        <div class="accordion-title">Récolte des céréales</div>
    </div>
    <div class="accordion-content" style="">
        <ul>
            <li>Nom de l'exploitation agricole : <span id="agri_nomExploitation">—</span></li>
            <li>Téléphone : <span id="agri_telephone">—</span></li>
            <li>Commune : <span id="agri_commune">—</span></li>
            <li>Code postal (agriculteur) : <span id="agri_codePostal">—</span></li>
            <li>N° SIRET : <span id="agri_siret">—</span></li>
            <li>Date de validité certification bio : <span id="agri_dateCertificationBio">—</span></li>
            <li>Identifiant de la parcelle (n° PAC) : <span id="agri_numeroParcellePAC">—</span></li>
            <li>Surface de la parcelle (ha) : <span id="agri_surfaceParcelle">—</span></li>
            <li>Coordonnées GPS de la parcelle (Latitude) : <span id="agri_gpsLatitude">—</span></li>
            <li>Coordonnées GPS de la parcelle (Longitude) : <span id="agri_gpsLongitude">—</span></li>
            <li>Type de céréale cultivée : <span id="agri_typeCerealeCultivee">—</span></li>
            <li>Variété de céréale : <span id="agri_varieteCereale">—</span></li>
            <li>Y a-t-il eu un travail du sol ? <span id="agri_travailSol">—</span></li>
            <li>Et un désherbage mécanique ? <span id="agri_desherbageMecanique">—</span></li>
            <li>Si oui, combien de passages ? <span id="agri_nombrePassages">—</span></li>
            <li>Y a-t-il une présence de fertilisation organique ? <span id="agri_fertilisationOrganique">—</span></li>
            <li>Type de fertilisation : <span id="agri_typeFertilisation">—</span></li>
            <li>Quantité (t/ha) : <span id="agri_quantiteFertilisation">—</span></li>
            <li>Utilisation de l'irrigation : <span id="agri_utilisationIrrigation">—</span></li>
            <li>Quantité : <span id="agri_quantiteIrrigation">—</span></li>
            <li>Événements particuliers ayant eu lieu : <span id="agri_evenementsParticuliers">—</span></li>
            <li>Date de la récolte : <span id="agri_dateRecolte">—</span></li>
            <li>Tonnage récolté : <span id="agri_tonnageRecolte">—</span></li>
            <li>Stockage à la ferme : <span id="agri_stockageFerme">—</span></li>
            <li>Date de livraison à la Malterie Occitane : <span id="agri_dateLivraisonMalterie">—</span></li>
            <li>Poids net livré à la Malterie : <span id="agri_poidsNetLivreMalterie">—</span></li>
            <li>Distance du site de stockage à la Malterie (km) : <span id="agri_distanceStockageMalterie">—</span></li>
            <li>Livraison à une coopérative : <span id="agri_livraisonCooperative">—</span></li>
            <li>Date de livraison à la coopérative : <span id="agri_dateLivraisonCoop">—</span></li>
            <li>Poids net livré (Agriculteur) : <span id="agri_poidsNetLivreAgriculteur">—</span></li>
            <li>Humidité de la récolte (%) : <span id="agri_humiditeRecolte">—</span></li>
            <li>Taux de protéines à la récolte (%) : <span id="agri_proteinesRecolte">—</span></li>
            <li>Teneur en impuretés (%) : <span id="agri_impuretesRecolte">—</span></li>
</ul>
    </div>
</div>
<!-- ACCORDÉONS Malterie-->
<div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)" style="background-image:url(&#39;malt-4950433_1280.jpg&#39;);">
        <div class="accordion-title">Maltage (Malterie Occitane)</div>
    </div>
    <div class="accordion-content">
        
        <ul>
            <li>N° du lot de céréales : <span id="malterie_numeroLot">—</span></li>
            <li>Date de réception du lot : <span id="malterie_dateReceptionLot">—</span></li>
            <li>Type de céréale : <span id="malterie_typeCereale">—</span></li>
            <li>Variété : <span id="malterie_variete">—</span></li>
            <li>Bio ou conventionnel : <span id="malterie_bioConventionnel">—</span></li>
            <li>Masse du lot (en t) : <span id="malterie_masseLotT">—</span></li>
            <li>Triage, calibrage, nettoyage : <span id="malterie_triageCalibrage">—</span></li>
            <li>Date de production : <span id="malterie_dateProduction">—</span></li>
            <li>Nommer le fournisseur : <span id="malterie_fournisseur">—</span></li>
            <li>Silo (ou lieu) d'origine : <span id="malterie_siloOrigine">—</span></li>
            <li>Nom : <span id="malterie_nom">—</span></li>
            <li>Code postal Malterie : <span id="malterie_codePostal">—</span></li>
            <li>Distance à la Malterie (en km) : <span id="malterie_distanceMalterie">—</span></li>
            <li>Nombre de trempes : <span id="malterie_nombreTrempes">—</span></li>
            <li>Temps de trempage : <span id="malterie_tempsTrempage">—</span></li>
            <li>Volume d'eau total utilisé : <span id="malterie_volumeEau">—</span></li>
            <li>Masse du lot : <span id="malterie_masseLot">—</span></li>
            <li>Masse de grains germés : <span id="malterie_masseGrainsGermes">—</span></li>
            <li>Hauteur de la couche (en cm) : <span id="malterie_hauteurCouche">—</span></li>
            <li>Température du lit (en °C) : <span id="malterie_temperatureLit">—</span></li>
            <li>Temps de germination (en heures) : <span id="malterie_tempsGermination">—</span></li>
            <li>Temps du touraillage (en heures) : <span id="malterie_tempsTouraillage">—</span></li>
            <li>Nombre de palliers : <span id="malterie_nombrePaliers">—</span></li>
            <li>Température moyenne de séchage (en °C) : <span id="malterie_temperatureSechage">—</span></li>
            <li>Brasserie 1 : <span id="malterie_brasserie1">—</span></li>
            <li>Brasserie 2 : <span id="malterie_brasserie2">—</span></li>
            <li>Brasserie 3 : <span id="malterie_brasserie3">—</span></li>
            <li>Brasserie 4 : <span id="malterie_brasserie4">—</span></li>
            <li>Brasserie 5 : <span id="malterie_brasserie5">—</span></li>
            <li>Brasserie 6 : <span id="malterie_brasserie6">—</span></li>
            <li>Brasserie 7 : <span id="malterie_brasserie7">—</span></li>
            <li>Brasserie 8 : <span id="malterie_brasserie8">—</span></li>
            <li>Brasserie 9 : <span id="malterie_brasserie9">—</span></li>
            <li>Brasserie 10 : <span id="malterie_brasserie10">—</span></li>
            <li>Taux d'humidité début production (%) : <span id="malterie_humiditeDebut">—</span></li>
            <li>Taux d'humidité fin production (%) : <span id="malterie_humiditeFin">—</span></li>
            <li>Taux de protéines début production (%) : <span id="malterie_proteinesDebut">—</span></li>
            <li>Taux de protéines fin production (%) : <span id="malterie_proteinesFin">—</span></li>
            <li>Extrait brut début production (%) : <span id="malterie_extraitDebut">—</span></li>
            <li>Extrait brut fin production (%) : <span id="malterie_extraitFin">—</span></li>
            <li>Teneur en Beta-Glucanes début production : <span id="malterie_betaGlucanesDebut">—</span></li>
            <li>Teneur en Beta-Glucanes fin production : <span id="malterie_betaGlucanesFin">—</span></li>
            <li>Teneur en impuretés début production : <span id="malterie_impuretesDebut">—</span></li>
            <li>Teneur en impuretés fin production : <span id="malterie_impuretesFin">—</span></li>
        </ul>
    </div>
</div>



<!-- ACCORDÉONS Brasserie-->
<div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)" style="background-image:url(&#39;beer-2370783_1280.jpg&#39;);">
        <div class="accordion-title">Brassage</div>
    </div>
    <div class="accordion-content">
        <ul>
            <li>Identification du lot (Brasserie) : <span id="brasserie_identificationLot">—</span></li>
            <li>Nom de la brasserie : <span id="brasserie_nom">—</span></li>
            <li>Code postal Brasserie : <span id="brasserie_codePostal">—</span></li>
            <li>Date du brassage : <span id="brasserie_dateBrassage">—</span></li>
            <li>Volume du brassin : <span id="brasserie_volumeBrassin">—</span></li>
            <li>Style de bière : <span id="brasserie_styleBiere">—</span></li>
            <li>Type de malt utilisé : <span id="brasserie_typeMalt">—</span></li>
            <li>Quantité de malt utilisé (en kg) : <span id="brasserie_quantiteMalt">—</span></li>
            <li>Ratio (en kg ou % du versement total) : <span id="brasserie_ratioMalt">—</span></li>
            <li>Origine / Fournisseur : <span id="brasserie_origineMalt">—</span></li>
            <li>N° de lot du malt : <span id="brasserie_numeroLotMalt">—</span></li>
            <li>Variété(s) de houblon utilisée(s) : <span id="brasserie_varieteHoublon">—</span></li>
            <li>Ratio (en kg ou % du versement total) : <span id="brasserie_ratioHoublon">—</span></li>
            <li>Origine / Fournisseur : <span id="brasserie_origineHoublon">—</span></li>
            <li>Souche / type de levure utilisé : <span id="brasserie_levureType">—</span></li>
            <li>Origine : <span id="brasserie_levureOrigine">—</span></li>
            <li>Correction apportée à l'eau : <span id="brasserie_correctionEau">—</span></li>
            <li>pH corrigé de départ : <span id="brasserie_phDepart">—</span></li>
            <li>pH corrigé en fin de brassage : <span id="brasserie_phFin">—</span></li>
            <li>Dureté de l'eau : <span id="brasserie_dureteEau">—</span></li>
            <li>Additifs / Ingrédients spéciaux : <span id="brasserie_additifs">—</span></li>
            <li>Consommation d'eau pour ce brassin : <span id="brasserie_consoEauBrassin">—</span></li>
            <li>Consommation d'eau pour le nettoyage : <span id="brasserie_consoEauNettoyage">—</span></li>
            <li>Consommation d'énergie estimée : <span id="brasserie_consoEnergie">—</span></li>
            <li>Valorisation des drêches : <span id="brasserie_valorisationDreches">—</span></li>
            <li>Comment ? : <span id="brasserie_commentDreches">—</span></li>
            <li>Gestion des déchets/recyclage : <span id="brasserie_gestionDechets">—</span></li>
            <li>Comment ? : <span id="brasserie_commentDechets">—</span></li>
            <li>Mode de conditionnement de la bière : <span id="brasserie_conditionnement">—</span></li>
        </ul>
    </div>
</div>

<!-- FOOTER -->
<footer>
    <div class="footer-infos">
        <div class="footer-block">
            <img src="Capture_d_écran_2025-11-17_220106-removebg-preview.png" alt="">
            <div class="footer-text">
                <strong>Malterie Occitane</strong><br>
                malterieoccitane.fr<br>
                1273 Avenue des Terres Noires, 81370 St Sulpice la Pointe
            </div>
        </div>
        <div class="footer-block">
            <img src="content.png" alt="">
            <div class="footer-text">
                <strong>The Malt Initiative – Projet Grain Trust :</strong><br>
                Projet Ingénieur Agronome de l’AgroToulouse<br>
                Mail : themaltinitiative@gmail.com
            </div>
        </div>
    </div>
</footer>

<script>

// --- ACCORDIONS ---
function toggleAccordion(header) {
    const content = header.nextElementSibling;
    const isOpen = content.classList.contains("open"); // Vérifie si la classe open est présente

    // Fermer tous les accordéons
    document.querySelectorAll('.accordion-content').forEach(c => {
        c.style.maxHeight = null;
        c.classList.remove("open");
    });

    // Ouvrir celui cliqué s'il n'était pas ouvert
    if (!isOpen) {
        content.style.maxHeight = content.scrollHeight + "px";
        content.classList.add("open");
    }
}

// Nettoyage des nombres (virgules françaises, chaînes vides, etc.)
function cleanNumber(val){
    if(val === undefined || val === null) return 0;
    if(typeof val === "number") return val;
    return parseFloat(
        String(val)
            .replace(/\s/g, "")
            .replace(",", ".")
    ) || 0;
}

// Set text sécurisé
function setTextSafe(id, value){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = (value !== undefined && value !== null && value !== "")
        ? value
        : "—";
}
    
function parseCSV(csvText) {
    const lines = csvText.trim().split(/\r?\n/);
    if(lines.length < 2) return [];

    // Récupérer les en-têtes
    const headers = parseCSVLine(lines[0]);

    const data = lines.slice(1).map(line => {
        const values = parseCSVLine(line);
        const obj = {};
        headers.forEach((h,i) => obj[h] = values[i] || '');
        return obj;
    });

    return data;
}

// Parse une ligne CSV avec guillemets et virgules
function parseCSVLine(line) {
    const result = [];
    let cur = '';
    let inQuotes = false;

    for(let i=0;i<line.length;i++){
        const char = line[i];

        if(char === '"' && line[i-1] !== '\\') {
            inQuotes = !inQuotes;
        } else if(char === ',' && !inQuotes) {
            result.push(cur.trim().replace(/^"|"$/g,''));
            cur = '';
        } else {
            cur += char;
        }
    }
    result.push(cur.trim().replace(/^"|"$/g,''));
    return result;
}

// Masquer automatiquement les champs vides
function masquerChampsVides() {
    document.querySelectorAll("li").forEach(li => {
        const span = li.querySelector("span");
        if (!span) return;
        const valeur = span.textContent.trim();
        if (valeur === "" || valeur === "—" || valeur === "-" || valeur.toLowerCase() === "null") {
            li.style.display = "none";
        } else {
            li.style.display = "list-item";
        }
    });
}

// Fonction sécurisée pour mettre à jour un span
function setTextSafe(id, value) {
    const el = document.getElementById(id);
    if(el) el.textContent = value || '—';
}

// Mettre à jour l’empreinte carbone
function updateCarbon(line) {

    const agri = Number((line["Agriculture :"] || "0").replace(',', '.')) || 0;
    const transp = Number((line["Transport :"] || "0").replace(',', '.')) || 0;
    const malt = Number((line["Malterie :"] || "0").replace(',', '.')) || 0;

    const total = agri + transp + malt;

    // Texte
    setTextSafe("Agriculture", agri + " kg CO₂");
    setTextSafe("Transport", transp + " kg CO₂");
    setTextSafe("Malterie", malt + " kg CO₂");
    setTextSafe("Total", total + " kg CO₂");

    if (total > 0) {
        document.getElementById("segAgriculture").style.width = (agri / total * 100) + "%";
        document.getElementById("segTransport").style.width = (transp / total * 100) + "%";
        document.getElementById("segMalterie").style.width = (malt / total * 100) + "%";
    } else {
        document.getElementById("segAgriculture").style.width = "0%";
        document.getElementById("segTransport").style.width = "0%";
        document.getElementById("segMalterie").style.width = "0%";
    }

    // Cartes
    document.getElementById("statAgriculture").textContent = agri + " kg CO₂";
    document.getElementById("statTransport").textContent = transp + " kg CO₂";
    document.getElementById("statMalterie").textContent = malt + " kg CO₂";
    document.getElementById("statTotal").textContent = total + " kg CO₂";
}



// Mettre à jour la page avec la ligne sélectionnée
function updatePageWithLine(line){
    if(!line) return;

    // ===== Mapping CSV -> ID HTML =====
const fields = {
    // === Agriculture / Exploitant ===
    "Nom de l'exploitation agricole :": "agri_nomExploitation",
    "Téléphone :": "agri_telephone",
    "Commune :": "agri_commune",
    "Code Postal Agriculteur :": "agri_codePostal",
    "N°SIRET :": "agri_siret",
    "Date de validité certification bio ": "agri_dateCertificationBio",
    "Identifiant de la parcelle (n°PAC) :": "agri_numeroParcellePAC",
    "Surface de la parcelle (ha) :": "agri_surfaceParcelle",
    "Coordonnées GPS de la parcelle (Latitude) :": "agri_gpsLatitude",
    "Coordonnées GPS de la parcelle (Longitude) :": "agri_gpsLongitude",
    "Type de céréale cultivée :": "agri_typeCerealeCultivee",
    "Variété de céréale :": "agri_varieteCereale",
    "Y a-t-il eu un travail du sol ?": "agri_travailSol",
    "Et un désherbage mécanique ?": "agri_desherbageMecanique",
    "Si oui combien de passages ?": "agri_nombrePassages",
    "Y a-t-il une présence de fertilisation organique ?": "agri_fertilisationOrganique",
    "Type de fertilisation :": "agri_typeFertilisation",
    "Quantité (t/ha) :": "agri_quantiteFertilisation",
    "Utilisation de l'irrigation :": "agri_utilisationIrrigation",
    "Quantité :": "agri_quantiteIrrigation",
    "Événements particuliers ayant eu lieu :": "agri_evenementsParticuliers",
    "Date de la récolte :": "agri_dateRecolte",
    "Tonnage récolté :": "agri_tonnageRecolte",
    "Stockage à la ferme :": "agri_stockageFerme",
    "Date de livraison à la Malterie Occitane :": "agri_dateLivraisonMalterie",
    "Poids net livré Malterie :": "agri_poidsNetLivreMalterie",
    "Distance du site de stockage à la Malterie (en km) :": "agri_distanceStockageMalterie",
    "Livraison à une coopérative :": "agri_livraisonCooperative",
    "Date de livraison à la coopérative :": "agri_dateLivraisonCoop",
    "Poids net livré (Agriculteur) :": "agri_poidsNetLivreAgriculteur",
    "Humidité de la récolte (en %) (Agriculteur) :": "agri_humiditeRecolte",
    "Taux de protéines à la récolte (en %) (Agriculteur):": "agri_proteinesRecolte",
    "Teneur en impuretés (en %) (Agriculteur):": "agri_impuretesRecolte",

    // === Malterie ===
    "N° du lot de céréales :": "malterie_numeroLot",
    "Date de réception du lot :": "malterie_dateReceptionLot",
    "Type de céréale :": "malterie_typeCereale",
    "Variété :": "malterie_variete",
    "Bio ou conventionnel :": "malterie_bioConventionnel",
    "Masse du lot (en t) :": "malterie_masseLotT",
    "Triage, calibrage, nettoyage (à spécifier) :": "malterie_triageCalibrage",
    "Date de production :": "malterie_dateProduction",
    "Nommer le fournisseur :": "malterie_fournisseur",
    "Silo (ou lieu) d'origine :": "malterie_siloOrigine",
    "Nom :": "malterie_nom",
    "Code postal Malterie :": "malterie_codePostal",
    "Distance à la Malterie (en km) :": "malterie_distanceMalterie",
    "Nombre de trempes :": "malterie_nombreTrempes",
    "Temps de trempage :": "malterie_tempsTrempage",
    "Volume d'eau total utilisé :": "malterie_volumeEau",
    "Masse du lot :": "malterie_masseLot",
    "Masse de grains germés :": "malterie_masseGrainsGermes",
    "Hauteur de la couche (en cm) :": "malterie_hauteurCouche",
    "Température du lit (en °C) :": "malterie_temperatureLit",
    "Temps de germination (en heures) :": "malterie_tempsGermination",
    "Temps du touraillage (en heures) :": "malterie_tempsTouraillage",
    "Nombre de palliers :": "malterie_nombrePaliers",
    "Température moyenne de séchage (en °C) :": "malterie_temperatureSechage",
    "Brasserie 1 :": "malterie_brasserie1",
    "Brasserie 2 :": "malterie_brasserie2",
    "Brasserie 3 :": "malterie_brasserie3",
    "Brasserie 4 :": "malterie_brasserie4",
    "Brasserie 5 :": "malterie_brasserie5",
    "Brasserie 6 :": "malterie_brasserie6",
    "Brasserie 7 :": "malterie_brasserie7",
    "Brasserie 8 :": "malterie_brasserie8",
    "Brasserie 9 :": "malterie_brasserie9",
    "Brasserie 10 :": "malterie_brasserie10",
    "Taux d'humidité au début de la production (en %) :": "malterie_humiditeDebut",
    "Taux d'humidité à la fin de la production (en %) :": "malterie_humiditeFin",
    "Taux de protéines au début de la production (en %) :": "malterie_proteinesDebut",
    "Taux de protéines à la fin de la production (en %) :": "malterie_proteinesFin",
    "Extrait brut au début de la production (en %) :": "malterie_extraitDebut",
    "Extrait brut à la fin de la production (en %) :": "malterie_extraitFin",
    "Teneur en Beta-Glucanes au début de la production :": "malterie_betaGlucanesDebut",
    "Teneur en Beta-Glucanes à la fin de la production :": "malterie_betaGlucanesFin",
    "Teneur en impuretés au début de la production :": "malterie_impuretesDebut",
    "Teneur en impuretés à la fin de la production :": "malterie_impuretesFin"
};


    // Boucle sur les champs
    for(const [csvKey, id] of Object.entries(fields)){
    setTextSafe(id, line[csvKey] || ''); // ajouter un fallback pour éviter undefined
    }

    // Mettre à jour l'empreinte carbone
    updateCarbon(line);

    // Masquer automatiquement les champs vides
    masquerChampsVides();
}

// --- CHARGEMENT DU LOT ---
async function loadLot() {
    const loadBtn = document.getElementById('loadBtn');
    const lotInput = document.getElementById('lotInput').value.trim();
    if (!lotInput) { alert("Veuillez entrer un numéro de lot !"); return; }

    const isAdult = confirm("Ce site présente des informations liées à l'alcool.\nConfirmez-vous avoir plus de 18 ans ?");
    if (!isAdult) { alert("Accès refusé : vous devez être majeur."); return; }

    const parts = lotInput.split('-');
    if(parts.length !== 2){ alert("Format invalide : MO-1"); return; }

    const csvFile = parts[0];
    const idRecherche = parts[1];

    const loader = document.getElementById('loader');
    loader.style.display = "flex";
    loadBtn.disabled = true;
    loadBtn.style.opacity = 0.6;
    loadBtn.style.cursor = 'not-allowed';

    await new Promise(r => setTimeout(r, 500));

    const csvPath = `https://raw.githubusercontent.com/themaltinitiative-ops/Malt-Initiative/master/data/${csvFile}.csv`;

    try {
        const response = await fetch(csvPath);
        if(!response.ok) throw new Error("Fichier CSV introuvable");

        const csvText = await response.text();
        const lotData = parseCSV(csvText);


        const line = data.find(d => (d["ID de la réponse"] || '').trim() === idRecherche.trim());
        if(!line) throw new Error("ID non trouvé dans le CSV");

        updatePageWithLine(line);

    } catch(err){
        alert("Erreur : " + err.message);
    } finally {
        loader.style.display = "none";
        loadBtn.disabled = false;
        loadBtn.style.opacity = '';
        loadBtn.style.cursor = '';
    }
}

document.getElementById('loadBtn').addEventListener('click', loadLot);
</script>
