<script>
// --- ACCORDION ---
function toggleAccordion(header){
    const content = header.nextElementSibling;
    const isOpen = content.style.maxHeight;

    document.querySelectorAll('.accordion-content').forEach(c => {
        c.style.maxHeight = null;
        c.classList.remove("open");
    });

    if(!isOpen){
        content.style.maxHeight = content.scrollHeight + "px";
        content.classList.add("open");
    }
}

// utilitaire pour nettoyer/changer string -> nombre
function cleanNumber(str) {
    if (!str && str !== 0) return 0;
    const num = parseFloat(String(str).replace(/[^\d.-]/g,''));
    return isNaN(num) ? 0 : num;
}

// Parse simple CSV clé,valeur (une paire par ligne)
function parseLotCSV(csv){
    if (!csv) return null;
    const lines = csv.trim().split(/\r?\n/);
    const obj = {};
    lines.forEach(line => {
        const idx = line.indexOf(',');
        if (idx === -1) return;
        const key = line.slice(0, idx).trim();
        const value = line.slice(idx + 1).trim();
        if (key) obj[key] = value;
    });
    return obj;
}

// Met à jour l'UI avec les données du lot
function updatePageWithLot(lot){
    if (!lot) {
        alert("Données du lot invalides.");
        return;
    }

    const agri = cleanNumber(lot["Émission Agriculture"]);
    const transp = cleanNumber(lot["Émission Transport"]);
    const malt = cleanNumber(lot["Émission Malterie"]);
    const total = cleanNumber(lot["Émission Total"]) || (agri + transp + malt);

    const rule = document.getElementById('carbonRule');
    rule.innerHTML = '';

    const safeTotal = total === 0 ? 1 : total;

    const makeSeg = (cls, val) => {
        const pct = Math.max(0, Math.min(100, (val / safeTotal) * 100));
        const div = document.createElement('div');
        div.className = 'seg ' + cls;
        div.style.width = pct + '%';
        rule.appendChild(div);
    };
    makeSeg('agri', agri);
    makeSeg('transp', transp);
    makeSeg('malt', malt);

    document.getElementById('valAgri').textContent = agri.toFixed(1);
    document.getElementById('valTransp').textContent = transp.toFixed(1);
    document.getElementById('valMalt').textContent = malt.toFixed(1);
    document.getElementById('valTotal').textContent = total.toFixed(1);

    document.getElementById('recolteNom').textContent = lot["Nom de l’exploitation"] || '—';
    document.getElementById('recolteLieu').textContent = lot["Lieu exploitation"] || '—';
    document.getElementById('recolteType').textContent = lot["Type et variété de céréales"] || '—';
    document.getElementById('recolteDate').textContent = lot["Date de moisson"] || '—';
    document.getElementById('recolteEvent').textContent = lot["Événements particuliers"] || '—';
    document.getElementById('recolteBio').textContent = lot["Date validité certification bio"] || '—';
    document.getElementById('coopNom').textContent = lot["Nom de la coopérative"] || '—';
    document.getElementById('coopLieu').textContent = lot["Lieu coopérative"] || '—';
    document.getElementById('coopDate').textContent = lot["Date réception céréales"] || '—';
    document.getElementById('coopType').textContent = lot["Type / variété céréales (coop)"] || '—';
    document.getElementById('coopCert').textContent = lot["Certification coopérative"] || '—';
    document.getElementById('qualHumid').textContent = lot["Humidité (%)"] || '—';
    document.getElementById('qualProt').textContent = lot["Taux de protéines (%)"] || '—';
    document.getElementById('qualImpure').textContent = lot["Teneur en impuretés (%)"] || '—';
    document.getElementById('qualPoids').textContent = lot["Poids spécifique (kg/hL)"] || '—';
}

// --- CHARGEMENT DU LOT ---
async function loadLot() {
    const loadBtn = document.getElementById('loadBtn');
    const lotId = document.getElementById('lotInput').value.trim();
    if (!lotId) {
        alert("Veuillez entrer un numéro de lot !");
        return;
    }

    // Vérification majorité
    const isAdult = confirm("Ce site présente des informations liées à l'alcool.\nConfirmez-vous avoir plus de 18 ans ?");
    if (!isAdult) {
        alert("Accès refusé : vous devez être majeur pour continuer.");
        return;
    }

    // Montrer le loader + désactiver le bouton
    const loader = document.getElementById('loader');
    loader.style.display = "flex";
    loader.setAttribute('aria-hidden', 'false');
    loadBtn.disabled = true;
    loadBtn.style.opacity = 0.6;
    loadBtn.style.cursor = 'not-allowed';

    // --- Attente forcée de 1 seconde ---
    await new Promise(resolve => setTimeout(resolve, 1000));

    const csvPath = `https://raw.githubusercontent.com/themaltinitiative-ops/Malt-Initiative/master/data/${lotId}.csv`;

    try {
        const response = await fetch(csvPath);
        if (!response.ok) throw new Error("Fichier CSV introuvable (404)");

        const csvText = await response.text();
        const lot = parseLotCSV(csvText);
        if (!lot || Object.keys(lot).length === 0)
            throw new Error("Données CSV invalides ou vides");

        updatePageWithLot(lot);

        // --- OUVERTURE AUTOMATIQUE DE LA PREMIÈRE BANNIÈRE ---
        const firstHeader = document.querySelector('.accordion .accordion-header');
        if (firstHeader) toggleAccordion(firstHeader);

    } catch (err) {
        alert("Erreur : " + err.message);
    } finally {
        loader.style.display = "none";
        loader.setAttribute('aria-hidden', 'true');
        loadBtn.disabled = false;
        loadBtn.style.opacity = '';
        loadBtn.style.cursor = '';
    }
}

// lie le bouton au chargement
document.getElementById('loadBtn').addEventListener('click', loadLot);
</script>
