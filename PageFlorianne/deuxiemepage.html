<script>
// --- ACCORDION ---
function toggleAccordion(header){
    const content = header.nextElementSibling;
    const isOpen = content.style.maxHeight;

    document.querySelectorAll('.accordion-content').forEach(c => {
        c.style.maxHeight = null;
        c.classList.remove("open");
    });

    if(!isOpen){
        content.style.maxHeight = content.scrollHeight + "px";
        content.classList.add("open");
    }
}

// ------------------------------
//  RÉCUPÉRATION DU NUMÉRO DE LOT
// ------------------------------
const urlParams = new URLSearchParams(window.location.search);
const lotId = urlParams.get("lot");  // ex : ?lot=202601

if(!lotId){
    alert("Aucun numéro de lot fourni.");
}

// ------------------------------
//  LECTURE DU FICHIER CSV
// ------------------------------
function parseCSV(csv){
    const lines = csv.trim().split(/\r?\n/);
    const headers = lines[0].split(",");

    return lines.slice(1).map(line => {
        const data = line.split(",");
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = data[i] ? data[i].trim() : "");
        return obj;
    });
}

fetch(`data/${lotId}.csv`)
.then(res => res.text())
.then(csv => {
    const rows = parseCSV(csv);
    const lot = rows[0]; // toujours 1 ligne par lot

    if(!lot){
        alert("Lot introuvable dans le fichier CSV.");
        return;
    }

    // ------------------------------
    //  EMPREINTE CARBONE
    // ------------------------------
    const sums = {
        agriculture: parseFloat(lot.emission_agriculture),
        transport: parseFloat(lot.emission_transport),
        malterie: parseFloat(lot.emission_malterie)
    };
    const total = sums.agriculture + sums.transport + sums.malterie;

    const rule = document.getElementById('carbonRule');
    rule.innerHTML = '';

    const makeSeg = (cls, val) => {
        const pct = val / total * 100;
        const div = document.createElement("div");
        div.className = "seg " + cls;
        div.style.width = pct + "%";
        rule.appendChild(div);
    };

    makeSeg("agri", sums.agriculture);
    makeSeg("transp", sums.transport);
    makeSeg("malt", sums.malterie);

    document.getElementById("valAgri").textContent = sums.agriculture.toFixed(1);
    document.getElementById("valTransp").textContent = sums.transport.toFixed(1);
    document.getElementById("valMalt").textContent = sums.malterie.toFixed(1);
    document.getElementById("valTotal").textContent = total.toFixed(1);

    // ------------------------------
    //  RECOLTE
    // ------------------------------
    document.getElementById("recolteNom").textContent = lot.nom_exploitation;
    document.getElementById("recolteLieu").textContent = lot.lieu_exploitation;
    document.getElementById("recolteType").textContent = lot.type_cereale;
    document.getElementById("recolteDate").textContent = lot.date_moisson;
    document.getElementById("recolteEvent").textContent = lot.evenements || "—";
    document.getElementById("recolteBio").textContent = lot.certification_bio || "—";

    // ------------------------------
    //  COOPÉRATIVE
    // ------------------------------
    document.getElementById("coopNom").textContent = lot.nom_cooperative;
    document.getElementById("coopLieu").textContent = lot.lieu_cooperative;
    document.getElementById("coopDate").textContent = lot.date_reception || "—";
    document.getElementById("coopType").textContent = lot.type_coop || "—";
    document.getElementById("coopCert").textContent = lot.certification_coop || "—";

    // ------------------------------
    //  QUALITÉ DU GRAIN
    // ------------------------------
    document.getElementById("qualHumid").textContent = lot.humidite;
    document.getElementById("qualProt").textContent = lot.proteines;
    document.getElementById("qualImpure").textContent = lot.impuretes;
    document.getElementById("qualPoids").textContent = lot.poids_specifique;

    // ------------------------------
    //  MALTERIE
    // ------------------------------
    document.getElementById("maltEtape1").textContent = lot.etape_reception;
    document.getElementById("maltEtape2").textContent = lot.etape_trempage;
    document.getElementById("maltEtape3").textContent = lot.etape_germination;
    document.getElementById("maltEtape4").textContent = lot.etape_touraillage;
    document.getElementById("maltEtape5").textContent = lot.etape_degermination;
    document.getElementById("maltEtape6").textContent = lot.etape_analyses;
})
.catch(err => {
    console.error("Erreur CSV :", err);
    alert("Impossible de charger les données du lot.");
});
</script>
