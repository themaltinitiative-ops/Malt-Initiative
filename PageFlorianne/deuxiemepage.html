<div class="carbon-card">
    <h2>Empreinte carbone — Lot : <span id="lotDisplay"></span></h2>

    <div class="carbon-title">Empreinte carbone du malt en kg CO₂ / kg de malt</div>
    <div class="carbon-rule" id="carbonRule"></div>

    <div class="numbers">
        <div class="stat agri"><small>Agriculture</small><strong id="valAgri">—</strong><span> kg CO₂ / kg de malt</span></div>
        <div class="stat transp"><small>Transport</small><strong id="valTransp">—</strong><span> kg CO₂ / kg de malt</span></div>
        <div class="stat malt"><small>Malterie</small><strong id="valMalt">—</strong><span> kg CO₂ / kg de malt</span></div>
        <div class="stat total"><small>Total</small><strong id="valTotal">—</strong><span> kg CO₂ / kg de malt</span></div>
    </div>
</div>

<script>
const databaseCSV = `
lot_id,agriculture,transport,malterie
MALT-2025-001,120.5,45.3,30.2
MALT-2025-002,150,50,40
MALT-2025-003,110.2,42.8,25.4
`;

function parseCSV(csv) {
    const [header, ...lines] = csv.trim().split(/\r?\n/);
    const headers = header.split(',').map(h => h.trim());
    return lines.map(line => {
        const values = line.split(',').map(v => v.trim());
        const obj = {};
        headers.forEach((h,i) => obj[h] = values[i]);
        return obj;
    });
}

const database = parseCSV(databaseCSV);
const rule = document.getElementById('carbonRule');
const lotNumber = localStorage.getItem("lotNumber");
document.getElementById("lotDisplay").textContent = lotNumber;

// Recherche automatique du lot
const found = database.find(row => row.lot_id.toUpperCase() === lotNumber.toUpperCase());
if(found){
    const sums = {
        agriculture: parseFloat(found.agriculture)||0,
        transport: parseFloat(found.transport)||0,
        malterie: parseFloat(found.malterie)||0
    };
    const total = sums.agriculture + sums.transport + sums.malterie;

    rule.innerHTML = '';
    const makeSeg = (cls,val) => {
        const pct = val/total*100;
        const div = document.createElement('div');
        div.className = 'seg ' + cls;
        div.style.width = pct + '%';
        rule.appendChild(div);
    };
    makeSeg('agri',sums.agriculture);
    makeSeg('transp',sums.transport);
    makeSeg('malt',sums.malterie);

    document.getElementById('valAgri').textContent = sums.agriculture.toFixed(1);
    document.getElementById('valTransp').textContent = sums.transport.toFixed(1);
    document.getElementById('valMalt').textContent = sums.malterie.toFixed(1);
    document.getElementById('valTotal').textContent = total.toFixed(1);
} else {
    rule.innerHTML = "";
    ['valAgri','valTransp','valMalt','valTotal'].forEach(id=>document.getElementById(id).textContent='—');
}
</script>
