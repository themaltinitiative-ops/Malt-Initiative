<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transparence – Informations du lot</title>

<style>
/* --- RESET ET BODY --- */
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #F7F3ED;
    color: #0f1724;
    padding: 0;
}

    /* Loader */
#loader {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(255,255,255,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
    display: none; /* caché par défaut */
}
#loader img {
    width: 150px;
    animation: spin 1.5s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
/* Bannière */
.header-images img { width: 100%; height: auto; display: block; }

/* --- TITRE --- */
h1 {
    text-align: center;
    margin: 20px 0;
}

/* --- CHAMP DE LOT --- */
#lotInput, button {
    font-size: 16px;
}

/* --- ACCORDIONS --- */
.accordion {
    background: #f0e6d2;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    margin: 20px auto;
    max-width: 900px;
}

.accordion-header {
    background-size: cover;
    background-position: center;
    height: 180px;
    position: relative;
    cursor: pointer;
}

.accordion-header::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.35);
}

.accordion-title {
    position: absolute;
    bottom: 10px;
    left: 20px;
    font-size: 26px;
    color: white;
    font-weight: bold;
    z-index: 5;
}

.accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
    background: #fff;
    padding: 0 20px;
}

.accordion-content.open {
    padding: 20px;
}

/* --- LISTES --- */
ul {
    margin: 10px 0 20px 20px;
    padding: 0;
    list-style-type: disc;
}

ul li {
    margin-bottom: 6px;
}

/* --- RÉGLETTE CARBONE --- */
.carbon-rule {
    height: 48px;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    align-items: center;
    margin-top: 12px;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
}

.seg {
    height: 100%;
    display: inline-block;
    transition: width 0.3s ease;
}

.seg.agri { background: #15803d; }
.seg.transp { background: #d9f99d; }
.seg.malt { background: #fde68a; }

.numbers {
    display: flex;
    gap: 16px;
    margin-top: 16px;
    flex-wrap: wrap;
}

.stat {
    padding: 14px;
    border-radius: 12px;
    border: 1px solid transparent;
    min-width: 140px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    font-size: 14px;
}

.stat.agri { background: #15803d; color: #fff; border-color: #064e3b; }
.stat.transp { background: #d9f99d; border-color: #15803d; }
.stat.malt { background: #fde68a; border-color: #b45309; }
.stat.total { background: #fff; border-color: #e2e8f0; color: #0f1724; }
.stat strong { display: block; font-size: 20px; margin-top: 4px; }

/* --- FOOTER --- */
footer {
    background: #e2e2e2;
    padding: 20px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
}

footer .footer-block {
    display: flex;
    align-items: center;
    margin: 10px;
}

footer .footer-block img {
    max-width: 80px;
    margin-right: 15px;
}

footer .footer-text {
    font-size: 14px;
    line-height: 1.4;
}
</style>
</head>
<body>


    <!-- Loader -->
<div id="loader">
    <img src="Pp/Dessin_chope_de_biere_480x480-removebg-preview.png" alt="Chargement...">
</div>

    
<!-- BANNIERE -->
<div class="header-images">
    <img src="bannire-fine.png" alt="Bannière The Malt Initiative">
</div>

<h1>Informations du Lot</h1>

<!-- CHAMP DE SAISIE DU LOT -->
<div style="text-align:center; margin:20px;">
    <label for="lotInput"><strong>Entrer le numéro de lot :</strong></label>
    <input type="text" id="lotInput" placeholder="Ex : 202601" style="padding:6px 10px; border-radius:6px; border:1px solid #ccc;">
    <button onclick="loadLot()" style="padding:6px 12px; border-radius:6px; border:none; background:#15803d; color:white; cursor:pointer;">Charger le lot</button>
</div>

<!-- ACCORDÉON EMPREINTE CARBONE -->
<div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)" style="background-image:url('vue-des-arbres-de-la-foret-verte-avec-co2 (2).jpg');">
        <div class="accordion-title">
            <img src="icon-carbone.png" style="width:40px;vertical-align:middle;margin-right:10px;">
            Empreinte carbone du lot
        </div>
    </div>
    <div class="accordion-content">
        <div>
            <div class="carbon-rule" id="carbonRule"></div>
            <div class="numbers">
                <div class="stat agri"><small>Agriculture</small><strong id="valAgri">—</strong></div>
                <div class="stat transp"><small>Transport</small><strong id="valTransp">—</strong></div>
                <div class="stat malt"><small>Malterie</small><strong id="valMalt">—</strong></div>
                <div class="stat total"><small>Total</small><strong id="valTotal">—</strong></div>
            </div>
        </div>
    </div>
</div>

<!-- ACCORDÉON RÉCOLTE -->
<div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)" style="background-image:url('barley.jpg');">
        <div class="accordion-title">Récolte des céréales</div>
    </div>
    <div class="accordion-content">
        <h3>Agriculteur</h3>
        <ul>
            <li>Nom de l’exploitation : <span id="recolteNom">—</span></li>
            <li>Lieu : <span id="recolteLieu">—</span></li>
            <li>Type et variété de céréales : <span id="recolteType">—</span></li>
            <li>Date de moisson : <span id="recolteDate">—</span></li>
            <li>Événements particuliers : <span id="recolteEvent">—</span></li>
            <li>Date de validité certification bio : <span id="recolteBio">—</span></li>
        </ul>
        <h3>Coopérative</h3>
        <ul>
            <li>Nom de la coopérative : <span id="coopNom">—</span></li>
            <li>Lieu : <span id="coopLieu">—</span></li>
            <li>Date de réception des céréales : <span id="coopDate">—</span></li>
            <li>Type et variété de céréales : <span id="coopType">—</span></li>
            <li>Certification bio ou autres certifications : <span id="coopCert">—</span></li>
        </ul>

        <h3>Qualité de grain</h3>
        <ul>
            <li>Humidité (%) : <span id="qualHumid">—</span></li>
            <li>Taux de protéines (%) : <span id="qualProt">—</span></li>
            <li>Teneur en impuretés (%) : <span id="qualImpure">—</span></li>
            <li>Poids spécifique (kg/hL) : <span id="qualPoids">—</span></li>
        </ul>
    </div>
</div>

<!-- ACCORDÉON MALTERIE -->
<div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)" style="background-image:url('malt-4950433_1280.jpg');">
        <div class="accordion-title">Maltage (Malterie Occitane)</div>
    </div>
    <div class="accordion-content">
        <h3>Étapes du procédé</h3>
        <ul>
            <li>Réception des lots : <span id="maltEtape1">—</span></li>
            <li>Trempage : <span id="maltEtape2">—</span></li>
            <li>Germination : <span id="maltEtape3">—</span></li>
            <li>Touraillage : <span id="maltEtape4">—</span></li>
            <li>Dégermination : <span id="maltEtape5">—</span></li>
            <li>Analyses finales : <span id="maltEtape6">—</span></li>
        </ul>
    </div>
</div>

<!-- ACCORDÉON BRASSAGE -->
<div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion(this)" style="background-image:url('beer-2370783_1280.jpg');">
        <div class="accordion-title">Brassage</div>
    </div>
    <div class="accordion-content">
        <p>Informations sur le brassage à compléter.</p>
    </div>
</div>

<!-- FOOTER -->
<footer>
    <div class="footer-infos">
        <div class="footer-block">
            <img src="Capture_d_écran_2025-11-17_220106-removebg-preview.png" alt="Capture_d_écran_2025-11-17_220106-removebg-preview">
            <div class="footer-text">
                <strong>Malterie Occitane</strong><br>
                malterieoccitane.fr<br>
                1273 Avenue des Terres Noires, 81370 St Sulpice la Pointe
            </div>
        </div>

        <div class="footer-block">
            <img src="content.png" alt="PageFlorianne/content.png">
            <div class="footer-text">
                <strong>The Malt Initiative – Projet Grain Trust :</strong><br>
                Projet Ingénieur Agronome de l’AgroToulouse<br>
                Mail : themaltinitiative@gmail.com
            </div>
        </div>
    </div>
</footer>

<script>
// --- ACCORDION ---
function cleanNumber(str) {
    if (!str) return 0;
    // Supprime tout sauf les chiffres et le point
    const num = parseFloat(str.replace(/[^\d.-]/g,''));
    return isNaN(num) ? 0 : num;
}
function toggleAccordion(header){
    const content = header.nextElementSibling;
    const isOpen = content.style.maxHeight;

    document.querySelectorAll('.accordion-content').forEach(c => {
        c.style.maxHeight = null;
        c.classList.remove("open");
    });

    if(!isOpen){
        content.style.maxHeight = content.scrollHeight + "px";
        content.classList.add("open");
    }
}

// --- CHARGEMENT DU LOT SELON LE NUMÉRO ---
async function loadLot() {
    const lotId = document.getElementById('lotInput').value.trim();
    if (!lotId) {
        alert("Veuillez entrer un numéro de lot !");
        return;
    }

    // URL brute GitHub correcte
    const csvPath = `https://raw.githubusercontent.com/themaltinitiative-ops/Malt-Initiative/master/data/${lotId}.csv`;

    try {
        const response = await fetch(csvPath);
        if (!response.ok) throw new Error("Fichier CSV introuvable");
        const csvText = await response.text();
        const lot = parseLotCSV(csvText);
        if (!lot) throw new Error("Données invalides");

        updatePageWithLot(lot);
    } catch (err) {
        alert("Erreur : " + err.message);
    }
}

// --- PARSE CSV ---
function parseLotCSV(csv){
    const lines = csv.trim().split(/\r?\n/);
    const obj = {};
    lines.forEach(line => {
        const [key, value] = line.split(',');
        if (key && value) obj[key.trim()] = value.trim();
    });
    return obj;
}

// --- MET À JOUR LA PAGE ---
function updatePageWithLot(lot){
    const agri = cleanNumber(lot["Émission Agriculture"]);
    const transp = cleanNumber(lot["Émission Transport"]);
    const malt = cleanNumber(lot["Émission Malterie"]);
    const total = cleanNumber(lot["Émission Total"]);

    const rule = document.getElementById('carbonRule');
    rule.innerHTML = '';
    const makeSeg = (cls, val) => {
        const pct = val/total*100;
        const div = document.createElement('div');
        div.className = 'seg ' + cls;
        div.style.width = pct + '%';
        rule.appendChild(div);
    };
    makeSeg('agri', agri);
    makeSeg('transp', transp);
    makeSeg('malt', malt);

    document.getElementById('valAgri').textContent = agri.toFixed(1);
    document.getElementById('valTransp').textContent = transp.toFixed(1);
    document.getElementById('valMalt').textContent = malt.toFixed(1);
    document.getElementById('valTotal').textContent = total.toFixed(1);

    // autres infos texte
    document.getElementById('recolteNom').textContent = lot["Nom de l’exploitation"];
    document.getElementById('recolteLieu').textContent = lot["Lieu exploitation"];
    document.getElementById('recolteType').textContent = lot["Type et variété de céréales"];
    document.getElementById('recolteDate').textContent = lot["Date de moisson"];
    document.getElementById('recolteEvent').textContent = lot["Événements particuliers"];
    document.getElementById('recolteBio').textContent = lot["Date validité certification bio"];
    document.getElementById('coopNom').textContent = lot["Nom de la coopérative"];
    document.getElementById('coopLieu').textContent = lot["Lieu coopérative"];
    document.getElementById('coopDate').textContent = lot["Date réception céréales"];
    document.getElementById('coopType').textContent = lot["Type / variété céréales (coop)"];
    document.getElementById('coopCert').textContent = lot["Certification coopérative"];
    document.getElementById('qualHumid').textContent = cleanNumber(lot["Humidité (%)"]);
    document.getElementById('qualProt').textContent = cleanNumber(lot["Taux de protéines (%)"]);
    document.getElementById('qualImpure').textContent = cleanNumber(lot["Teneur en impuretés (%)"]);
    document.getElementById('qualPoids').textContent = cleanNumber(lot["Poids spécifique (kg/hL)"]);
}

</script>

</body>
</html>
